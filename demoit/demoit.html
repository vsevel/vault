
<h1>Deploy Hashicorp Vault with Consul on Kubernetes</h1>

<div class="logos">
        <img src="/images/k8s_vault_consul.png" />
</div>

---

<h1>Goals</h1>

<h2>A (near) enterprise ready secret management solution</h2>
<h2>Educational: How easy is it to integrate solutions into Kubernetes</h2>

---

<h1>About myself</h1>

<h2>20+ Technical Architect</h2>
<h2>Private Banking</h2>
<h2>Product, Consulting, Training, Community Manager</h2>
<h2>Development, Middleware, Cloud/Kubernetes/OpenShift</h2>
<h2>https://github.com/vsevel/vault</h2>
<h2>https://www.linkedin.com/in/vincent-sevel/</h2>

---

<h1>Why Vault, why Consul?</h1>

<h2>Vault: De facto standard for secret management</h2>
<h2>Consul: Works well with Vault as Storage backend</h2>
<h2>Complete solution brings interesting integration challenges</h2>

---

<h1>My first Vault</h1>

<div class="split">
    <web-term path="1-vault"></web-term>
    <source-code folder="1-vault"
        files="vault-deployment.yaml vault-pvc.yaml vault-config.json vault-service.yaml cheat-sheet"
        start-lines="0"
        end-lines="0">
    </source-code>
</div>

---

<h1>My first Vault</h1>

<img src="/images/diag1.png" />

---

<h1>My first Vault: Recap</h1>

<h2>NodePort Service</h2>
<h2>Deployment</h2>
<h2>StorageClass</h2>
<h2>PV & PVC</h2>
<h2>ConfigMap</h2>
<h2>Imperative vs Declarative</h2>

---

<h1>My first Vault: Can we do better?</h1>

<h2>HA Storage</h2>
<h2>Ingress vs NodePort</h2>
<h2>TLS</h2>
<h2>Liveness vs Readyness</h2>
<h2>Kubernetes Authentication Delegation</h2>

---

<h1>Vault Storage Options</h1>

<h2>19 options: Azure, Cassandra, ...</h2>
<h2>(but only 8 for) HA Storage: </h2>
<h2>**Consul**</h2>
<h2>DynamoDB</h2>
<h2>Etcd</h2>
<h2>FoundationDB</h2>
<h2>Google Cloud Spanner</h2>
<h2>Google Cloud Storage</h2>
<h2>MySQL</h2>
<h2>Zookeeper</h2>

---

<h1>Helm: the Kubernetes Package Manager</h1>

<img src="/images/helm.png" />

---

<h1>HA Consul Storage</h1>

<div class="split">
    <web-term path="2-vault"></web-term>
    <source-code folder="2-vault"
        files="cheat-sheet values.yaml vault-deployment.yaml"
        start-lines="0;0;30"
        end-lines="0;0;61">
    </source-code>
</div>

---

<h1>HA Consul Storage</h1>

<img src="/images/diag2.png" />

---

<h1>HA Consul Storage: Recap</h1>

<h2>StatefulSet</h2>
<h2>DaemonSet</h2>
<h2>API Server</h2>
<h2>Helm</h2>
<h2>Opportunity: -retry-join 'provider=k8s label_selector="app=consul,component=server"'</h2>

---

<h1>Ingress</h1>

<h2>Expose services outside the cluster</h2>
<h2>Requires an ingress controller (eg Nginx)</h2>

---

<h1>Ingress</h1>

<div class="split">
    <web-term path="3-vault"></web-term>
    <source-code folder="3-vault"
        files="cheat-sheet vault-ingress.yaml vault-service.yaml"
        start-lines="0;0;0"
        end-lines="0;0;0">
    </source-code>
</div>

---

<h1>Ingress</h1>

<img src="/images/diag3.png" />

---

<h1>Ingress: Recap</h1>

<h2>Ingress Controller: nginx</h2>
<h2>Ingress</h2>

---

<h1>TLS</h1>

<h2>Avoid man-in-the middle attack</h2>
<h2>Confidentiality</h2>
<h2>Inside and outside the cluster</h2>

---

<h1>TLS</h1>

<div class="split">
    <web-term path="4-vault"></web-term>
    <source-code folder="4-vault"
        files="cheat-sheet create-cert.sh vault-csr.json vault-deployment.yaml vault-ingress.yaml nginx-ingress-controller.yaml"
        start-lines="0;0;0;58,64,70,75,77;7,17;222"
        end-lines="0;0;0;59,65,70,75,79;7,18;223">
    </source-code>
</div>

---

<h1>TLS</h1>

<img src="/images/diag4.png" />

---

<h1>TLS: Recap</h1>

<h2>CSR</h2>
<h2>Required on all inter-pod communications</h2>
<h2>Consul intra-cluster communications: gossip</h2>
<h2>OpenShift: edge, passthrough and reencrypt</h2>
<h2>Fast forward: Istio</h2>

---

<h1>Readiness & Liveness</h1>

<h2>Readiness: traffic is not dispatched</h2>
<h2>Liveness: pod gets restarted</h2>
<h2>Critical piece of a resilient architecture</h2>

---

<h1>Readiness & Liveness</h1>

<div class="split">
    <web-term path="5-vault"></web-term>
    <source-code folder="5-vault"
        files="cheat-sheet vault-deployment.yaml"
        start-lines="0;73"
        end-lines="0;73">
    </source-code>
</div>

---

<h1>Readiness & Liveness: Recap</h1>

<h2>Readiness: pod not ready to accept traffic</h2>
<h2>Liveness: pod needs to be restarted</h2>

---

<h1>Fecthing Secrets</h1>

<h2>How do I fetch secrets?</h2>
<h2>Integration with k8s: Auth delegation</h2>

---

<h1>Fecthing Secrets</h1>

<div class="split">
    <web-term path="6-vault"></web-term>
    <source-code folder="6-vault"
        files="cheat-sheet cluster-role-auth-delegator.yaml mypolicy.hcl myapp.yaml"
        start-lines="0;0;0;0"
        end-lines="0;0;0;0">
    </source-code>
</div>

---

<h1>Fecthing Secrets</h1>

<img src="/images/diag6.png" />

---

<h1>Fetching Secrets: Recap</h1>

<h2>Mounted jwt & trusted certificate bundle</h2>
<h2>Vault communicates with Token Review API</h2>
<h2>Role = service accounts + policies</h2>

---

<h1>Vault Admin</h1>

<h2>How do I know a vault needs to be unsealed?</h2>
<h2>How do I unseal my vaults?</h2>
<h2>How do I list vaults?</h2>
<h2>How do I address a specific vault?</h2>
<h2>Challenge: seal status is an in-memory state</h2>

---

<h1>Vault Admin</h1>

<div class="split">
    <web-term path="7-vault"></web-term>
    <source-code folder="7-vault"
        files="cheat-sheet role-pod-reader.yaml"
        start-lines="0;0"
        end-lines="0;0">
    </source-code>
</div>

---

<h1>Vault Admin</h1>

<img src="/images/diag7.png" />

---

<h1>Vault Admin: Recap</h1>

<h2>API Server</h2>
<h2>DNS A record “pod-ip-address.my-namespace.pod.cluster.local“</h2>
<h2>Should Vault be a StatefulSet?</h2>
<h2>Opportunity: Auto Unseal with HSM PKCS11, AWS KMS, ...</h2>

---

<h1>Conclusion</h1>

<h2>Kubernetes: An integrator's dream</h2>
<h2>The toolbox is huge, and continously improving</h2>
<h2>Vault+Consul: A good fit for Kubernetes</h2>
<h2>Some feature relevance quesions in a k8s world (dns server, ...)?</h2>

---

<h1>Questions</h1>

<img src="/images/questions.png" />
